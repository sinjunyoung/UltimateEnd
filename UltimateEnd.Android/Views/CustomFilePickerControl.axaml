<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:UltimateEnd.Android.ViewModels"
             xmlns:models="using:UltimateEnd.Android.Models"
             x:Class="UltimateEnd.Views.CustomFilePickerControl"
             x:DataType="vm:CustomFilePickerViewModel"
             Background="Transparent">

	<Grid x:Name="MainGrid" RowDefinitions="Auto,Auto,*,Auto">

		<!-- 상단 경로 표시 (Breadcrumb) -->
		<Border Grid.Row="0" Background="{DynamicResource Background.Secondary}" Padding="10,8">
			<ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
				<ItemsControl ItemsSource="{Binding BreadcrumbPaths}">
					<ItemsControl.ItemsPanel>
						<ItemsPanelTemplate>
							<StackPanel Orientation="Horizontal" Spacing="5"/>
						</ItemsPanelTemplate>
					</ItemsControl.ItemsPanel>
					<ItemsControl.ItemTemplate>
						<DataTemplate>
							<StackPanel Orientation="Horizontal">
								<Button Content="{Binding Name}"
										CommandParameter="{Binding}"
										Click="OnBreadcrumbClick"
										Padding="8,4"
										Background="Transparent"
										BorderThickness="0"
										Foreground="{DynamicResource Text.Primary}"/>
								<TextBlock Text="/"
										  Margin="3,0"
										  VerticalAlignment="Center"
										  Foreground="{DynamicResource Text.Secondary}"/>
							</StackPanel>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>
		</Border>

		<!-- 필터 정보 -->
		<Border Grid.Row="1" Background="{DynamicResource Background.Primary}" Padding="10,6">
			<TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="13" Foreground="{DynamicResource Text.Primary}"/>
		</Border>

		<!-- 파일/폴더 리스트 -->
		<Border Grid.Row="2" BorderBrush="{DynamicResource Background.Border}" BorderThickness="1">
			<Panel>
				<!-- 로딩 -->
				<Border IsVisible="{Binding IsLoading}"
						Background="{DynamicResource Background.Card}">
					<StackPanel HorizontalAlignment="Center"
							   VerticalAlignment="Center"
							   Spacing="10">
						<PathIcon Data="{StaticResource Icon.Loading}"
								  Width="32"
								  Height="32"
								  Foreground="{DynamicResource Text.Primary}"/>
						<TextBlock Text="Loading..." FontSize="14" Foreground="{DynamicResource Text.Primary}"/>
					</StackPanel>
				</Border>

				<!-- 파일/폴더 목록 -->
				<ScrollViewer Name="FileScrollViewer"
							  IsVisible="{Binding !IsLoading}">
					<ItemsControl Name="FileItemsControl"
								  ItemsSource="{Binding Files}"
								  Background="{DynamicResource Background.Primary}">
						<ItemsControl.ItemTemplate>
							<DataTemplate x:DataType="models:FileItem">
								<Border Name="FileItemBorder"
										Padding="12,10"
										Background="Transparent"
										Loaded="OnItemLoaded"
										Tapped="OnFileTapped"
										Cursor="Hand">
									<Grid ColumnDefinitions="Auto,*,Auto,Auto">

										<!-- 아이콘/썸네일 -->
										<Panel Grid.Column="0" Width="40" Height="40" Margin="0,0,12,0">
											<!-- 썸네일 (이미지/동영상) -->
											<Border IsVisible="{Binding Thumbnail, Converter={x:Static ObjectConverters.IsNotNull}}"
													Width="40"
													Height="40"
													CornerRadius="4"
													ClipToBounds="True"
													BorderBrush="{DynamicResource Background.Border}"
													BorderThickness="1">
												<Image Source="{Binding Thumbnail}"
													   Stretch="UniformToFill"/>
											</Border>

											<!-- PathIcon -->
											<Panel IsVisible="{Binding Thumbnail, Converter={x:Static ObjectConverters.IsNull}}">
												<!-- 부모 디렉토리 -->
												<PathIcon Data="{StaticResource Icon.Parent}"
														  Width="24" Height="24"
														  Foreground="{DynamicResource Text.Secondary}"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.Parent}}"/>

												<!-- 폴더 -->
												<PathIcon Data="{StaticResource Icon.Folder}"
														  Width="24" Height="24"
														  Foreground="#FFD700"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.Folder}}"/>

												<!-- 내부 저장소 -->
												<PathIcon Data="{StaticResource Icon.InternalStorage}"
														  Width="24" Height="24"
														  Foreground="#4CAF50"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.InternalStorage}}"/>

												<!-- SD 카드 -->
												<PathIcon Data="{StaticResource Icon.SdCard}"
														  Width="24" Height="24"
														  Foreground="#2196F3"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.SdCard}}"/>

												<!-- 이미지 -->
												<PathIcon Data="{StaticResource Icon.Image}"
														  Width="24" Height="24"
														  Foreground="#4CAF50"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.Image}}"/>

												<!-- 비디오 -->
												<PathIcon Data="{StaticResource Icon.Video}"
														  Width="24" Height="24"
														  Foreground="#F44336"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.Video}}"/>

												<!-- 오디오 -->
												<PathIcon Data="{StaticResource Icon.Audio}"
														  Width="24" Height="24"
														  Foreground="#9C27B0"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.Audio}}"/>

												<!-- 게임 -->
												<PathIcon Data="{StaticResource Icon.Game}"
														  Width="24" Height="24"
														  Foreground="#FF9800"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.Game}}"/>

												<!-- 기본 파일 -->
												<PathIcon Data="{StaticResource Icon.File}"
														  Width="24" Height="24"
														  Foreground="{DynamicResource Text.Secondary}"
														  IsVisible="{Binding IconType, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:FileIconType.File}}"/>
											</Panel>
										</Panel>

										<TextBlock Grid.Column="1"
												   Text="{Binding Name}"
												   FontSize="14"
												   VerticalAlignment="Center"
												   Foreground="{DynamicResource Text.Primary}"
												   TextWrapping="NoWrap"
												   TextTrimming="CharacterEllipsis"/>

										<TextBlock Grid.Column="2"
												   Text="{Binding DisplaySize}"
												   Foreground="{DynamicResource Text.Secondary}"
												   FontSize="12"
												   Margin="15,0"
												   VerticalAlignment="Center"
												   MinWidth="70"
												   TextAlignment="Right"/>

										<TextBlock Grid.Column="3"
												   Text="{Binding ModifiedDate, StringFormat='{}{0:MM/dd HH:mm}'}"
												   Foreground="{DynamicResource Text.Secondary}"
												   FontSize="11"
												   VerticalAlignment="Center"
												   IsVisible="{Binding !IsDirectory}"
												   MinWidth="90"/>
									</Grid>
								</Border>
							</DataTemplate>
						</ItemsControl.ItemTemplate>
					</ItemsControl>
				</ScrollViewer>
			</Panel>
		</Border>

		<!-- 하단 버튼 -->
		<Border Grid.Row="3"
				Background="{DynamicResource Background.Secondary}"
				Padding="15,10"
				BorderBrush="{DynamicResource Background.Border}"
				BorderThickness="0,1,0,0">
			<Grid ColumnDefinitions="*,Auto">

				<TextBlock Grid.Column="0"
						   Text="{Binding SelectedFile.Name, FallbackValue='파일을 선택하세요'}"
						   VerticalAlignment="Center"
						   FontSize="13"
						   Foreground="{DynamicResource Text.Secondary}"
						   TextTrimming="CharacterEllipsis"/>

				<Button Grid.Column="1"
						Content="취소"
						Foreground="{DynamicResource Text.Primary}"
						Width="100"
						Height="36"
						Click="OnCancelClick"/>
			</Grid>
		</Border>

	</Grid>
</UserControl>